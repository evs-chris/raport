{"version":3,"file":"diff.js","sources":["../src/play/diff.ts"],"sourcesContent":["import { evaluate } from 'raport/index';\nimport Ractive, { InitOpts, ContextHelper } from 'ractive';\n\nconst escRE = /[<>&]/g;\nconst escapes = { '<': '&lt;', '>': '&gt;', '&': '&amp;' };\n\nclass App extends Ractive {\n  constructor(opts?: InitOpts) {\n    super(opts);\n  }\n\n  diff(left: string, right: string) {\n    const l = this.parse(left);\n    const lcsv = this.get('csv');\n    const r = this.parse(right);\n    const rcsv = this.get('csv');\n    this.set('hasCSV', lcsv || rcsv);\n    const diff = evaluate({ left: l, right: r }, 'diff(left right)')\n    const res = {} as any;\n    for (const k in diff) res[k.replace(/^v\\./, '')] = diff[k];\n    return res;\n  }\n\n  parse(val: string) {\n    this.set('csv', false);\n    if (!val) return;\n    if (val[0] === '<') return evaluate({ val }, 'parse(val xml:1)');\n    const res = evaluate({ val }, 'parse(val)')?.v;\n    if (res === undefined || Object.keys(res).length === 1 && res.r && res.r.k) {\n      this.set('csv', true);\n      return evaluate({ val, header: this.get('csvHeader') }, `parse(val csv:1 detect:1 header:header)`);\n    }\n    return res;\n  }\n\n  string(val: any, comp?: any) {\n    if (val === undefined) return 'undefined';\n    if (comp && val && typeof comp === 'string' && typeof val === 'string') {\n      comp = evaluate({ val: comp }, `string(val ${this.get('format') || 'raport'}:1)`).replace(escRE, c => escapes[c]);\n      val = evaluate({ val }, `string(val ${this.get('format') || 'raport'}:1)`).replace(escRE, c => escapes[c]);\n      let i = 0;\n      for (; i < comp.length && i < val.length; i++) if (val[i] !== comp[i]) break;\n      return val.slice(0, i) + '<span class=highlight>' + val.slice(i) + '</span>';\n    }\n    return evaluate({ val }, `string(val ${this.get('format') || 'raport'}:1)`);\n  }\n}\n\nRactive.perComponentStyleElements = true;\nRactive.helpers.escapeKey = Ractive.escapeKey;\n\nRactive.extendWith(App, {\n  template: `\n<div class=differ style=\"display: flex; width: 100%; height: 100%;\">\n  <div style=\"flex-grow: 1; flex-shrink: 0; width: 33%; display: flex; flex-direction: column; position: relative;\">\n    <label style=\"position: absolute; left: 1rem; top: 0.4rem; font-size: 0.7em;\"><input type=checkbox checked=\"{{@style.dark}}\"> Dark mode?</label>\n    <select style=\"position: absolute; right: 4.2rem; top: 0.4rem;\" value=\"{{leftView}}\"><option value=\"{{undefined}}\">text</option><option>tree</option></select>\n    <h3>Left</h3>\n    {{#if leftView === 'tree'}}\n      {{>root @.parse(.left)}}\n    {{else}}\n      <textarea style=\"flex-grow: 1;\" placeholder=\"Left value here...\" lazy=1000>{{.left}}</textarea>\n    {{/if}}\n  </div>\n  <div style=\"position: relative; padding: 0.2rem; flex-grow: 1; flex-shrink: 0; width: 33%; display: flex; flex-direction: column; border-color: #aaa; border-style: solid; border-width: 0 1px 0 1px;\">\n    {{#if ~/leftView === 'tree' || ~/rightView === 'tree'}}<label style=\"position: absolute; left: 1rem; top: 0.4rem; font-size: 0.7em;\"><input type=checkbox checked=\"{{~/expandAll}}\"> Expand all tree nodes?</label>{{/if}}\n    <select style=\"position: absolute; right: 4.2rem; top: 0.4rem;\" value=\"{{format}}\"><option value=\"{{undefined}}\">raport</option><option>json</option></select>\n    <h3>Diff</h3>\n    <pre style=\"overflow: auto;\"><code>\n    {{#each @.diff(.left, .right)}}\n      <div style=\"display: flex; flex-wrap: wrap;\">\n        <div style=\"width: 100%; margin-top: 0.5rem; border-bottom: 1px solid #999; padding: 0.2rem; font-weight: 600;\">{{@key}}</div>\n        <div style=\"width: 50%; padding: 0.5rem; box-sizing: border-box;\">{{@.string(this.0)}}</div>\n        <div style=\"width: 50%; padding: 0.5rem; box-sizing: border-box; border-left: 1px dotted #aaa;\">{{{@.string(this.1, this.0)}}}</div>\n      </div>\n    {{/each}}\n    </code></pre>\n  </div>\n  <div style=\"flex-grow: 1; flex-shrink: 0; width: 33%; display: flex; flex-direction: column; position: relative;\">\n    {{#if ~/hasCSV}}<label style=\"position: absolute; left: 1rem; top: 0.4rem; font-size: 0.7em;\"><input type=checkbox checked=\"{{~/csvHeader}}\"> CSV Header?</label>{{/if}}\n    <select style=\"position: absolute; right: 4.2rem; top: 0.4rem;\" value=\"{{rightView}}\"><option value=\"{{undefined}}\">text</option><option>tree</option></select>\n    <h3>Right</h3>\n    {{#if rightView === 'tree'}}\n      {{>root @.parse(.right)}}\n    {{else}}\n      <textarea style=\"flex-grow: 1;\" placeholder=\"Right value here...\" lazy=1000>{{.right}}</textarea>\n    {{/if}}\n  </div>\n</div>\n\n{{#partial root}}\n  <div class=tree-view>\n    {{#if typeof . === 'object'}}<span style=\"color: #aaa; margin-left: 0.5em;\">{{Array.isArray(.) ? '[' : '{'}}</span>{{/if}}\n    <div class=root>\n      {{>tree .}}\n    </div>\n    {{#if typeof . === 'object'}}<span style=\"color: #aaa; margin-left: 0.5em;\">{{Array.isArray(.) ? ']' : '}'}}</span>{{/if}}\n  </div>\n{{/partial}}\n\n{{#partial tree}}\n  <div class=tree>\n    {{#each .}}\n      <div class=node>\n        <div class=key title=\"{{(@keypath + '').replace(/.*\\\\)\\\\./, '')}}\">{{@key}}<span style=\"color: #aaa;\">:</span>{{#if typeof . === 'object'}}<span style=\"color: #aaa; margin-left: 0.5em;\">{{Array.isArray(.) ? '[' : '{'}}</span>{{/if}}</div>\n        {{#unless ~/expandAll}}<div class=expand {{#if typeof . === 'object'}}class-show on-click=\"@.toggle('expand.' + escapeKey(@keypath))\"{{/if}}>{{#if ~/expand[@keypath]}}-{{else}}+{{/if}}</div>{{/unless}}\n        <div class=value class-children=\"typeof . === 'object' && (~/expandAll || ~/expand[@keypath])\">\n          {{#if typeof . === 'object'}}\n            {{#if ~/expandAll || ~/expand[@keypath]}}\n              {{>tree .}}\n              <span style=\"color: #aaa; margin-left: 0.5em;\">{{Array.isArray(.) ? ']' : '}'}}</span>\n            {{else}}\n              <div class=type>{{#if Array.isArray(.)}} ]{{else}} }{{/if}}</div>\n            {{/if}}\n          {{else}}{{@.string(.)}}{{/if}}\n        </div>\n      </div>\n    {{/each}}\n  </div>\n{{/partial}}\n`,\n  css(data) {\n    return `\nh3 { margin: 0.2rem; text-align: center; }\ntextarea { border: none; outline: none; padding: 0.2rem; }\npre { margin: 0; white-space: pre-wrap; word-break: break-all; }\n.tree-view { overflow: auto; flex-grow: 1; }\n.tree { margin-left: 0.5em; padding-left: 0.5em; border-left: 1px dotted #aaa; }\n.tree:hover { border-left-color: blue; }\n.tree .node { white-space: nowrap; }\n.tree .key { margin-left: 0.5em; display: inline-block; }\n.tree .type { color: #aaa; display: inline-block; }\n.tree .value { display: inline-block; vertical-align: top; white-space: pre-wrap; word-break: break-all; }\n.tree .children { display: block; }\n.tree .expand { display: none; width: 1em; height: 1em; box-sizing: border-box; border: 1px solid #aaa; color: #999; vertical-align: middle; line-height: 0.8em; text-align: center; display: none; cursor: pointer; }\n.tree .expand.show { display: inline-block; }\n.highlight { background-color: yellow; }\n${data('dark') ? `\n.differ, textarea { color: #ddd; background-color: #222; }\n.tree:hover { border-left-color: cyan; }\n.highlight { background-color: darkblue; }` : ''}\n`;\n  },\n  on: {\n    init() {\n      this.set('@style.dark', matchMedia('(prefers-color-scheme: dark)').matches);\n      try {\n        this.set(JSON.parse(window.localStorage.getItem('diff')));\n      } catch {}\n    }\n  },\n  observe: {\n    'left right format'() {\n      window.localStorage.setItem('diff', JSON.stringify({ left: this.get('left'), right: this.get('right'), format: this.get('format') }));\n    }\n  },\n});\n\nconst app = globalThis.app = new App({\n  target: 'body',\n});\n\n// simple debug helper\nlet el: any;\ndocument.addEventListener('click', ev => el = ev.target, { capture: true });\ndocument.addEventListener('focus', ev => el = ev.target, { capture: true });\n\nObject.defineProperty(globalThis, 'R', {\n  value: new Proxy(() => ({}), {\n    apply(_obj, _e, args) {\n      if (args.length) {\n        let ctx: ContextHelper;\n        if (typeof args[0] === 'object' && args[0] instanceof Node) ctx = Ractive.getContext(args.shift());\n        else ctx = Ractive.getContext(el);\n        if (!ctx) return;\n        if (typeof args[0] === 'string') {\n          if (args.length === 1) return ctx.get(args[0]);\n          else if (args.length === 2) return ctx.set(args[0], args[1]);\n        } else if (typeof args[0] === 'object') {\n          return ctx.set(args[0]);\n        }\n        return ctx;\n      } else {\n        return Ractive.getContext(el).get();\n      }\n    },\n    get(_obj, prop) {\n      const ctx = Ractive.getContext(el);\n      if (!ctx) return;\n      if (!(prop in ctx) && prop in ctx.ractive) {\n        const val = ctx.ractive[prop];\n        if (typeof val === 'function') return val.bind(ctx.ractive);\n        return val;\n      } else {\n        return ctx[prop];\n      }\n    },\n  }),\n});\n"],"names":["Ractive","evaluate"],"mappings":"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"}