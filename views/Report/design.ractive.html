{{#if report.type === 'delimited'}}
  <div class-scrolled-wrapper style-flex-grow=1><div as-scrolled><div style="padding: 3rem; min-width: min-content;">
    <div class="delimited paper">
      <div class="widget active-widget">
        <div class-bar>
          <span class-name>Report</span>
          {{#if !report.headers}}
            <span class-btn on-click="@.addHeader()">Add Header</span>
          {{else}}
            <span class-btn on-click="@.set('report.headers', undefined)">Remove Header</span>
          {{/if}}
        </div>
        <div class-children>
          {{#if !!~/report.headers}}
            <div class="widget hover-widget">
              <div class-bar>
                <span class-name>Header</span>
                <button on-click="@.push('report.headers', ''), @.push('report.fields', '')">Add Field</button>
              </div>
              <div class-children class-fields>
                {{#each report.headers}}
                  <div class="field" on-click="@.editExpr(@context)" class-active-expr="~/temp.expr.path === @keypath" as-expr=true><span>{{.}}</span><button title="Remove this field" class-ico on-click="@.removeWidget(@context), false">{{>times}}</button></div>
                {{/each}}
              </div>
            </div>
          {{/if}}
          <div class="widget hover-widget">
            <div class-bar>
              <span class-name>Row</span>
              <button on-click="@.push('report.fields', ''), ~/report.headers && @.push('report.headers', '')">Add Field</button>
            </div>
            <div class-children class-fields>
              {{#each report.fields}}
                <div class="field" on-click="@.editExpr(@context)" class-active-expr="~/temp.expr.path === @keypath" as-expr><span>{{.}}</span><button title="Remove this field" class-ico on-click="@.removeWidget(@context), false">{{>times}}</button></div>
              {{/each}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div></div></div>
{{else}}
  <div class=scrolled-wrapper style-flex-grow=1><div as-scrolled><div style="padding: 3rem; min-width: min-content;">
    <div class="paper" style="{{@.paperSize()}}" on-click="@event.target === @node ? @.selectWidget('report') : true">
      <div class=bar style-cursor=pointer on-click="@.unlink('widget'), @.unlink('expr'), @.set('temp', { name: 'report ', widget: 'report' })" class-active="temp.widget === 'report' || temp.widget === 'report.watermark' || temp.widget === 'report.overlay'" class-hover="temp.hover === 'report' || temp.hover === 'report.watermark' || temp.hover === 'report.overlay'" on-mouseover="@.set('temp.hover', ~/inWatermark ? 'report.watermark' : ~/inOverlay ? 'report.overlay' : 'report'), false" on-mouseout="@.set('temp.hover', ''), false">
        <span class-name>
          {{#if ~/inWatermark}}Watermark
          {{elseif ~/inOverlay}}Overlay
          {{else}}Report{{/if}}
        </span>
        {{#if report.type === 'page'}}
          {{#if !~/temp.widget || !/^report.(water|overlay)/.test(~/temp.widget)}}
            {{#if report.header}}
              <span class-btn on-click="@.set('report.header', undefined), @.unlink('widget'), @.set('temp.widget', '')">Remove page header</span>
            {{else}}
              <span class-btn on-click="@.set('report.header', { type: 'container' })">Add page header</span>
            {{/if}}

            {{#if report.footer}}
              <span class-btn on-click="@.set('report.footer', undefined), @.unlink('widget'), @.set('temp.widget', '')">Remove page footer</span>
            {{else}}
              <span class-btn on-click="@.set('report.footer', { type: 'container' })">Add page footer</span>
            {{/if}}
          {{/if}}
        {{/if}}

        {{#if report.watermark}}
          <span class-btn on-click="@.set('report.watermark', undefined), @.unlink('widget'), @.set('temp.widget', '')">Remove watermark</span>
          {{#unless ~/inWatermark}}<span class-btn on-click="@.link('report.watermark', 'widget'), @.set('temp.widget', 'report.watermark'), false">Edit watermark</span>{{/unless}}
        {{else}}
          <span class-btn on-click="@.set('report.watermark', { type: 'container' }), @.link('report.watermark', 'widget'), @.set('temp.widget', 'report.watermark'), false">Add watermark</span>
        {{/if}}

        {{#if report.overlay}}
          <span class-btn on-click="@.set('report.overlay', undefined), @.unlink('widget'), @.set('temp.widget', '')">Remove overlay</span>
          {{#unless ~/inOverlay}}<span class-btn on-click="@.link('report.overlay', 'widget'), @.set('temp.widget', 'report.overlay'), false">Edit overlay</span>{{/unless}}
        {{else}}
          <span class-btn on-click="@.set('report.overlay', { type: 'container' }), @.link('report.overlay', 'widget'), @.set('temp.widget', 'report.overlay'), false">Add overlay</span>
        {{/if}}

        {{#if /^report.(water|overlay)/.test(~/temp.widget)}}
          <span class-btn on-click="@.unlink('widget'), @.set('temp.widget', '')">Edit report</span>
        {{/if}}
      </div>
      {{#if ~/report.type === 'page' && ~/report.header}}{{>widget ~/report.header, 'page header' as label}}{{/if}}
      {{#if /^report.water/.test(~/temp.widget)}}
        {{#each ~/report.watermark.widgets}}
          {{>widget}}
        {{/each}}
      {{elseif /^report.overlay/.test(~/temp.widget)}}
        {{#each ~/report.overlay.widgets}}
          {{>widget}}
        {{/each}}
      {{else}}
        {{#each ~/report.widgets}}
          {{>widget}}
        {{/each}}
      {{/if}}
      {{#if ~/report.type === 'page' && ~/report.footer}}{{>widget ~/report.footer, 'page footer' as label}}{{/if}}
    </div>
  </div></div></div>
{{/if}}

<style rel=ractive>
  .paper {
    background-color: {{@style.bg}};
    color: {{@style.fg}};
    position: relative;
  }

  .delimited.paper {
    padding: 0.5rem;
    color: {{@style.fg}};
    background-color: {{@style.bg}};
  }
  @media screen and (min-width: 48rem) {
    .delimited.paper {
      margin: 1rem;
    }
  }

  .delimited .children.fields {
    display: flex;
    flex-wrap: wrap;
  }

  .field {
    display: flex;
    border: 1px solid {{@style.border}};
    margin: 0.25rem;
    padding: 0.25rem;
  }
  .field span {
    display: inline-block;
    width: 15em;
    min-height: 1em;
    max-height: 6em;
    word-break: break-all;
    white-space: pre-wrap;
    overflow: hidden;
  }
  .field.active-expr {
    background-color: {{@style.active}}20;
    border-color: {{@style.active}};
  }
  .field.hover-expr {
    background-color: {{@style.hover}}20;
    border-color: {{@style.hover}};
  }

  .widget span.btn {
    background-color: {{@style.fg}};
    color: {{@style.bg}};
  }
  .widget span.btn svg {
    fill: {{@style.bg}};
  }

  .widget .bar span.btn {
    background-color: transparent;
    color: {{@style.btntxt}};
  }

  .widget.container > .remove.btn {
    top: -1.5rem;
    right: 0.5rem;
    z-index: 1000;
  }
</style>
