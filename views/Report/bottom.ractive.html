<div class="bottom-bar" class-shrinkleft="~/show.shrinkleft">
  <div class-actions>
    {{#if ~/report.parameters.length}}<span title="Set values for report parameters" class-tab class-active="~/temp.bottom.tab === 'params'" on-click="@.set('temp.bottom.tab', 'params'), @.set('show.bottom', true)">Parameters</span>{{/if}}
    <span title="Evaluate expressions" class-tab class-active="!~/temp.bottom.tab || ~/temp.bottom.tab === 'expr'" on-click="@.set('temp.bottom.tab', 'expr'), @.set('show.bottom', true)">{{#if ~/temp.expr.path}}Expression{{else}}Evaluate{{/if}}</span>
    <span title="Expression language reference" class-tab class-active="~/temp.bottom.tab === 'langref'" on-click="@.set('temp.bottom.tab', 'langref'), @.set('show.bottom', true)">Language</span>
    <span title="Operator reference" class-tab class-active="~/temp.bottom.tab === 'opref'" on-click="@.set('temp.bottom.tab', 'opref'), @.set('show.bottom', true)">Operators</span>
    {{#if ~/temp.bottom.param}}<span title="Modify report parameter {{~/param.name}}" class-tab class-active="~/temp.bottom.tab === 'param'" on-click="@.set('temp.bottom.tab', 'param'), @.set('show.bottom', true)">Parameter</span>{{/if}}
    {{#if ~/temp.bottom.source}}<span title="Modify data source {{~/source.name || ~/source.source}}" class-tab class-active="~/temp.bottom.tab === 'source'" on-click="@.set('temp.bottom.tab', 'source'), @.set('show.bottom', true)">Source</span>{{/if}}
    
    {{#if ~/temp.expr.path && (!~/temp.bottom.tab || ~/temp.bottom.tab === 'expr')}}<span class-which on-click="@.checkLink('expr')" title="Close expression for {{~/temp.expr.path}}"><button class-ico>{{>times}}</button> {{~/temp.expr.path.replace(/\./g, ' \u232a ')}}</span>{{/if}}
    {{#if ~/temp.bottom.param && ~/temp.bottom.tab === 'param'}}<span class-which on-click="@.checkLink('param')" title="Close parameter editor for {{~/param.name}}"><button class-ico>{{>times}}</button> Parameter {{+@.lastKey(~/temp.bottom.param) + 1}}</span>{{/if}}
    {{#if ~/temp.bottom.source && ~/temp.bottom.tab === 'source'}}<span class-which on-click="@.checkLink('source')" title="Close source editor for {{~/temp.bottom.source}}"><button class-ico>{{>times}}</button> Source {{+@.lastKey(~/temp.bottom.source) + 1}}</span>{{/if}}
    <div style="flex-grow: 1;" />
    <button title="{{#if ~/max.bottom}}Shrink{{else}}Embiggen{{/if}} the bottom pane" on-click="@.toggle('max.bottom')" class-ico class="{{#if !~/max.bottom}}off{{/if}}" style="margin-left: 1rem;">{{>max}}</button>
    <button title="{{#if ~/show.bottom}}Hide{{else}}Show{{/if}} the bottom pane" on-click="@.toggle('show.bottom')" class-ico class="{{#if ~/show.bottom}}down{{else}}up{{/if}}-arrow">{{>arrow}}</button>
  </div>
</div>
<div class-bottom-pane class-active="~/show.bottom" class-max="~/max.bottom" class-shrinkleft="~/show.shrinkleft">
  <div class-bottom>
    <div class-tab class-active-tab="~/temp.bottom.tab === 'langref'">
      <iframe srcdoc="{{@.langref(~/settings.scale, @style.theme)}}" id=langref />
    </div>
    <div class-tab class-active-tab="~/temp.bottom.tab === 'opref'">
      <div class="ops-search">
        <input lazy=500 placeholder="Search..." value="{{opDocSearch}}" style="width: 10em; margin: 0.5em;" title="Find any operators with docs containing the string entered here." />
        <input lazy=500 placeholder="Operator..." value="{{opDoc}}" style="width: 10em; margin: 0.5em;" title="Find any operators with a name containing the string entered here." />
      </div>
      <div style="padding: 0.5rem; height: 100%; width: 100%; overflow: auto; box-sizing: border-box;">
        <div style="max-width: 60em; margin: auto;">
          <h2 style="text-align: center;">Raport Operators</h2>
          <dl>
            {{#each ~/operators as op}}{{#if (!~/opDoc || op.0.includes(~/opDoc)) && (!~/opDocSearch || JSON.stringify(op.1).toLowerCase().includes(~/opDocSearch.toLowerCase()))}}
            <dt style="border-bottom: 1px dotted; margin-bottom: 0.25rem; margin-top: 2rem;"><h3>{{op.0.0 === '#' ? 'Format ' + op.0.slice(1) : op.0}}{{#if op.1.alias}} <em style="font-size: 0.8em;"> - (alias for <strong>{{op.1.alias}}</strong>)</em>{{/if}}</h3></dt>
              <dd>
                <dl>
                  {{#each op.1.sig}}
                    <dt>
                      <strong>{{.proto}}</strong>{{#if .bin}} <em>or</em> <strong>arg1 {{op.0}} arg2</strong>{{/if}}{{#if .un}} or <strong>{{op.0}}arg1</strong>{{/if}}
                      {{#if .agg}}<br /><em>arg1 can implicitly be <code>@source</code></em>{{/if}}
                    </dt>
                    <dd>{{.desc}}</dd>
                  {{/each}}
                </dl>
                {{#if op.1.opts.length}}
                  <h4>Options</h4>
                  <dl>
                    {{#each op.1.opts}}
                    <dt><strong>{{Array.isArray(.name) ? .name.join(' or ') : .name}}{{#if .type}} - <em>{{.type}}</em>{{/if}}</strong></dt>
                      <dd>{{.desc}}</dd>
                    {{/each}}
                  </dl>
                {{/if}}
              </dd>
              {{/if}}{{/each}}
          </dl>
        </div>
      </div>
    </div>
    <div class-tab class-active-tab="!~/temp.bottom.tab || ~/temp.bottom.tab === 'expr'">
      <div class-editor>
        <div class-actions>
          <button title="Evaluate the current expression (CTRL+Enter)" disabled="{{!~/temp.expr.str}}" on-click="@.eval()" class-error="~/temp.expr.error" class-ico class-large>{{>play}}</button>
          <button title="Modify the current expression" class-tab class-active="~/temp.expr.tab === 'text'" on-click="@.set('temp.expr.tab', 'text')">{{#if ~/temp.expr.template}}Template{{else}}Text{{/if}}</button>
          {{#if ~/temp.expr.tab === 'text' && !~/temp.expr.template}}<button title="Format the current expression" class="ico text" on-click="@.fmt()">Format</button>{{/if}}
          {{#if ~/temp.expr.tab === 'text' && !~/temp.expr.path}}<label style="margin-left: 1em;" title="Enable to treat the current expression as a template"><input type=checkbox checked="{{~/temp.expr.template}}" /> Template?</label>{{/if}}
          {{#if ~/temp.expr.tab === 'parsed'}}
            <div class-editor-buttons>
              <div class=toggles>{{#with ~/temp.expr.parsedtype as t}}
                <span class-toggle class-active="!t || t === 'json'" {{#if t && t !== 'json'}}on-click="@.set('temp.expr.parsedtype', 'json')"{{/if}} title="Show the AST as JSON. Double click to copy the JSON to the clipboard." on-dblclick="@.copyToClipboard(JSON.stringify(~/temp.expr.ast))">JSON</span>
                <span class-toggle class-active="t === 'raport'" {{#if t !== 'raport'}}on-click="@.set('temp.expr.parsedtype', 'raport')"{{/if}} title="Show the AST as a Raport expression.">Raport</span>
              {{/with}}</div>
            </div>
            {{#if ~/temp.expr.parsedtype === 'json' || !~/temp.expr.parsedtype}}
              <label style="margin-left: 2em;"><input type=checkbox bind-checked="~/temp.expr.jsonsquash" title="Enable to display JSON with no additional whitespace" /> Compact?</label>
            {{/if}}
          {{/if}}
          <button title="Modify the current HTML template" class-tab style-display="{{~/temp.expr.html ? '' : 'none'}}" class-active="~/temp.expr.tab === 'html'" on-click="@.set('temp.expr.tab', 'html')">HTML</button>
          <div style-flex-grow=2 />
          <button title="View the result of the current expression's execution" class-tab class-active="~/temp.expr.tab === 'result'" on-click="@.set('temp.expr.tab', 'result')">Result</button>
          {{#if ~/temp.expr.parsed}}
            <button title="View the parse tree of the current expression" class-tab class-active="~/temp.expr.tab === 'parsed'" class-error="~/temp.expr.error" on-click="@.set('temp.expr.tab', 'parsed')">Parsed</button>
          {{/if}}
        </div>
        <div class-tab class-text class-active-tab="!~/temp.expr.tab || ~/temp.expr.tab === 'text'">
          {{#with ~/temp.expr}}
            {{#if .label}}
              {{#if Array.isArray(.str)}}
                <div style="display: flex; justify-content: space-between;">
                  <button title="Convert multipart label text into a single expression" class-plain on-click="@context.set('.str', @.getPartStrings(.str))">Convert to Text</button>
                  <button title="Add another part to this multipart label text" class-ico class-large on-click="@context.push('.str', '')">+</button>
                </div>
                <div class-scrolled-wrapper style-flex-grow=1>
                  <div as-scrolled>
                    {{#each .str}}
                      <div class-label-part>
                        <button class-ico class-spacer on-click="@context.splice('../', @index, 1)" title="Remove part">{{>times}}</button>
                        <button class-ico class-up-arrow disabled="{{@index === 0}}" on-click="@.moveUp(@context)" title="Move up">{{>arrow}}</button>
                        <button class-ico class-spacer class-down-arrow disabled="{{@index === @last}}" on-click="@.moveDown(@context)" title="Move down">{{>arrow}}</button>
                        {{#if typeof . === 'string'}}
                          <button class-ico on-click="@context.set('.', { text: . })" title="Format part">F</button>
                          <Editor src="{{.}}" primary="{{@index === 0}}" />
                        {{else}}
                          <button class-ico class-spacer on-click="@context.set('.', .text)" title="Convert to a plain text part with no formatting">T</button>
                          <input value="{{.id}}" placeholder="Tracking ID" title="Track this value by assigning it a unique ID" />
                          <Editor src="{{.text}}" primary="{{@index === 0}}" />
                          <input title="Font Family" placeholder="Font Family" value="{{.font.family}}" />
                          <input title="Color" placeholder="Color" value="{{.font.color}}" />
                          <input title="Size" placeholder="Size (1)" value="{{.font.size}}" type="number" />
                          <input title="Line Height" placeholder="Line Height ({{.font.size == null ? 1 : .font.size}})" value="{{.font.line}}" type="number" />
                          <select title="Font Weight" value="{{.font.weight}}">
                            <option value="{{undefined}}">Font Weight</option>
                            <option value="400">light</option>
                            <option value="500">normal</option>
                            <option value="600">bold</option>
                            <option value="700">bolder</option>
                          </select>
                          <label><input type="checkbox" checked="{{.font.pre}}" /> Significant whitespace?</label>
                          <input title="Background Color" placeholder="Background" value="{{.bg}}" />
                          <input title="Border Radius" placeholder="Radius" value="{{.radius}}" />
                        {{/if}}
                      </div>
                    {{/each}}
                  </div>
                </div>
              {{else}}
                <!-- <div>
                  <button title="Convert a single expression label text into a multipart label text that can have individual properties set per part" class-plain on-click="@context.set('.str', [.str])">Convert to Parts</button>
                </div> -->
                <div class-scrolled-wrapper style-flex-grow=1>
                  <div as-scrolled>
                    <Editor src="{{.str}}" template="{{.html || .template}}" on-run="~/temp.expr.tab === 'result' ? @.set('temp.expr.tab', 'text') : @.eval()" primary />
                  </div>
                </div>
              {{/if}}
            {{else}}
              <div class-scrolled-wrapper style-flex-grow=1>
                <div as-scrolled>
                  <Editor src="{{.str}}" template="{{.html || .template}}" on-run="~/temp.expr.tab === 'result' ? @.set('temp.expr.tab', 'text') : @.eval()" primary />
                </div>
              </div>
            {{/if}}
          {{/with}}
        </div>
        <div class-tab class-html class-active-tab="~/temp.expr.tab === 'html'">
          <div class-editor-buttons>
            <button on-click="@.command('bold')" title="Bold"><strong>B</strong></button>
            <button on-click="@.command('italic')" title="Italic"><em>I</em></button>
            <button on-click="@.command('underline')" title="Underline"><span style="text-decoration: underline;">U</span></button>
            <button on-click="@.command('strikeThrough')" title="Strike Through"><span style="text-decoration: line-through;">S</span></button>
            <select value="{{~/temp.fontSize}}" on-change="@.setHTMLFontSize()" title="Change Font Size">
              <option value=''>(font size)</option>
              <option value="{{1}}">smallest</option>
              <option value="{{2}}">smaller</option>
              <option value="{{3}}">small</option>
              <option value="{{4}}">regular</option>
              <option value="{{5}}">large</option>
              <option value="{{6}}">larger</option>
              <option value="{{7}}">largest</option>
            </select>
          </div>
          <div class-scrolled-wrapper><div as-scrolled>
            <div contenteditable=true class-html-editor value="{{~/temp.expr.htmlstr}}" id="expr-html" />
          </div></div>
        </div>
        <div class-tab class-result class-active-tab="~/temp.expr.tab === 'result'">
          <div class-editor-buttons>
            <div class=toggles>{{#with ~/temp.expr.resulttype as t}}
              <span class-toggle class-active="!t || t === 'plain'" {{#if t && t !== 'plain'}}on-click="@.set('temp.expr.resulttype', 'plain')"{{/if}} title="Show result as a plain string. Double click to copy the text to the clipboard." on-dblclick="@.copyToClipboard(~/temp.expr.result)">Plain</span>
              <span class-toggle class-active="t === 'json'" {{#if t !== 'json'}}on-click="@.set('temp.expr.resulttype', 'json')"{{/if}} title="Show result as JSON">JSON</span>
              <span class-toggle class-active="t === 'raport'" {{#if t !== 'raport'}}on-click="@.set('temp.expr.resulttype', 'raport')"{{/if}} title="Show result as a Raport expression">Raport</span>
              <span class-toggle class-active="t === 'html'" {{#if t !== 'html'}}on-click="@.set('temp.expr.resulttype', 'html')"{{/if}} title="Show result as HTML">HTML</span>
            {{/with}}</div>
            <div style="margin-left: 2em;">
              {{#if ~/temp.expr.resulttype === 'json'}}<label><input type=checkbox bind-checked="~/temp.expr.jsonsquash" title="Enable to display JSON with no additional whitespace" /> Compact?</label>{{/if}}
            </div>
          </div>
          <div class=scrolled-wrapper style-flex-grow=1><div as-scrolled>
            {{#if ~/temp.expr.result === undefined}}
              <span style="color: {{@style.code.c12}};">undefined</span>
            {{else}}
              {{#if ~/temp.expr.resulttype === 'html'}}
                {{{~/temp.expr.result}}}
              {{elseif ~/temp.expr.resulttype === 'json'}}
                <code><pre>{{JSON.stringify(~/temp.expr.result, null, ~/temp.expr.jsonsquash ? undefined : '  ')}}</pre></code>
              {{elseif ~/temp.expr.resulttype === 'raport'}}
                <code><pre>{{@.unparse(~/temp.expr.result)}}</pre></code>
              {{else}}
                <code><pre>{{~/temp.expr.result}}</pre></code>
              {{/if}}
            {{/if}}
          </div></div>
        </div>
        <div class-tab class-parsed class-active-tab="~/temp.expr.tab === 'parsed'">
          <div class=scrolled-wrapper style-flex-grow=1><div as-scrolled>
            <code><pre style-margin="1em">{{#if ~/temp.expr.errormsg}}{{~/temp.expr.errormsg}}{{else}}{{#if ~/temp.expr.parsedtype === 'raport'}}{{@.unparse(~/temp.expr.ast)}}{{else}}{{JSON.stringify(~/temp.expr.ast, null, ~/temp.expr.jsonsquash ? '' : '  ')}}{{/if}}{{/if}}</pre></code>
          </div></div>
        </div>
      </div>
      <div class-context style-display="{{~/temp.expr.tab === 'ast' || ~/temp.expr.tab === 'text' || ~/temp.expr.tab === 'html' ? '' : 'none'}}">
        <div class-header title="The approximate data that should be available in this expression's context"><div style="margin-right: 0.5em;">Context</div><div><input placeholder="Filter..." value="{{~/ctxsearch}}" lazy=500 style="width: 100%;" /></div></div>
        <div class-panel class-scrolled-wrapper><div as-scrolled>
          {{#if ~/temp.expr.ctx}}
            {{>expr-context ~/temp.expr.ctx}}
          {{/if}}
        </div></div>
      </div>
      <!-- <div class-ops style-display="{{~/temp.expr.tab === 'ast' || ~/temp.expr.tab === 'text' || ~/temp.expr.tab === 'html' ? '' : 'none'}}">
        <div class-header title="All of the builtin operators. Click an operator to insert it into an active text field. Hover over an operator for a tooltip with its documentation. Hold the shift key and click an operator for popup with its documentation."><div style="margin-right: 0.5em;">Operators</div><div><input placeholder="Search..." value="{{~/opsearch}}" lazy=500 /></div></div>
        <div class-panel class-scrolled-wrapper><div as-scrolled>
          {{~/temp.expr.tab === 'ast' && @context.decorators.scrolled && @context.decorators.scrolled.invalidate() || '' && ''}}
          {{#each ~/operators}}
            <div class-entry-details title="{{@.getOperatorDoc(this.0)}}">
              <button class-expr-operator on-click="@event.shiftKey ? @.showOperatorDoc(this.0) : @.insertOp(this.0)">{{this.0}}</button>
              <div class-entry-type>{{this.1.sig.0.bin && !this.1.alias ? 'binary' : ''}} {{this.1.sig.0.fmt ? 'format' : ''}} {{this.1.sig.0.agg ? 'aggregate' : ''}} {{this.1.sig.0.unary && !this.1.sig.alias ? 'unary' : ''}} {{this.1.alias ? 'alias' : ''}}</div>
            </div>
          {{/each}}
        </div></div>
      </div> -->
    </div>
    <div class-tab class-active-tab="~/temp.bottom.tab === 'param'" class-properties>
      {{#with ~/param}}
        <label title="The name used to reference this parameter e.g. !name"><span>Name</span><input value="{{.name}}" /></label>
        <label><span>Type</span><select value="{{.type}}">{{>types}}</select></label>
        {{#if .type === 'string'}}<label><span>Refine</span><select value="{{.refine}}">
          <option value="{{undefined}}">(none)</option>
          <option value="text">Multiline Text</option>
          <option value="code">Expression</option>
        </select></label>{{/if}}
        <label><input type=checkbox checked="{{.required}}" /> Require?</label>
        <label title="An alternative to the name to show in the parameter fill interface"><span>Label</span><input value="{{.label}}" /></label>
        {{#if .init === undefined}}
          <label title="Add an Initialization expression to provide a default for the parameter"><input type=checkbox twoway=false on-change="@context.set('.init', '')" /> Initialization expression?</label>
        {{else}}
          <label title="Add an Initialization expression to provide a default for the parameter"><input type=checkbox twoway=false checked on-change="@context.set('.init', undefined)" /> Initialization expression?</label>
          <div style="height: 5em; border: 1px solid {{@style.border}}; overflow: auto; margin: 0 0.5em;"><Editor src="{{.init}}" tabout /></div>
        {{/if}}
        <label title="Set up options to render the parameter as a select"><input type=checkbox twoway=false checked="{{Array.isArray(.options)}}" on-change="@context.set('.options', Array.isArray(.options) ? undefined : [])" /> Options?</label>
        {{#if Array.isArray(.options)}}
          <div class-options style="height: 100%; width: 30rem;">
            <h3>Options</h3>
            <div class="option-entry">
              {{#with @local as ctx}}
                <label><span>Label</span><br/><input value="{{ctx.label}}" /></label>
                <label><span>Value</span><br/><input value="{{ctx.value}}" /></label>
                <button disabled="{{!ctx.value}}" class-ico class-large on-click="@context.push('.options', !ctx.label ? ctx.value : { label: ctx.label, value: ctx.value }), @context.set({ 'ctx.label': '', 'ctx.value': '' })">+</button>
              {{/with}}
            </div>
            {{#if .options}}
              <div class-scrolled-wrapper><div as-scrolled>
                {{#each .options}}
                  <div>
                    {{#if typeof . === 'string'}}<input value="{{.}}" />
                    {{else}}<input value="{{.label}}" /> <input value="{{.value}}" />{{/if}}
                    <button class-ico on-click="@context.splice('../', @index, 1)">{{>times}}</button>
                  </div>
                {{/each}}
              </div></div>
            {{/if}}
          </div>
        {{/if}}
      {{/with}}
    </div>
    <div class-tab class-active-tab="~/temp.bottom.tab === 'params'" class-properties>
      {{>bottom-parameters}}
    </div>
    <div class-tab class-active-tab="~/temp.bottom.tab === 'source'" class-properties>
      {{#with ~/source}}
        <label title="Expose this source to the report context with this name. If none is provided, this source will be named based on its upstream source."><span>Name</span><input value="{{.name}}" /></label>
        {{#if ~~/temp.bottom.source.indexOf('widget')}}
          <label title="The upstream source that this source should be based on."><span>Source</span><select value="{{.source}}">{{#each ~/report.sources}}<option>{{.name}}</option>{{/each}}</select></label>
        {{else}}
          <label title="The upstream source that this source should be based on."><span>Source</span><select value="{{.source}}">{{#each ~/sources}}<option>{{.name}}</option>{{/each}}</select></label>
        {{/if}}
        <label title="An expression providing the base data for this source. This will override the upstream source, which is available in this expression as @source."><span>Base <button class-ico on-click="@.editExpr(~/temp.bottom.source + '.base')" tabindex=-1>{{>pencil}}</button></span><div style="height: 5em; border: 1px solid {{@style.border}}; overflow: auto; margin: 0;"><Editor src="{{.base}}" tabout /></div></label>
        <label title="A filter expression to apply to the source before it is used."><span>Filter <button class-ico on-click="@.editExpr(~/temp.bottom.source + '.filter')" tabindex=-1>{{>pencil}}</button></span><div style="height: 5em; border: 1px solid {{@style.border}}; overflow: auto; margin: 0;"><Editor src="{{.filter}}" tabout /></div></label>
        <label title="A sort expression to apply to the source before it is used. This should be an array of applications or config objects with by keys having application values."><span>Sort <button class-ico on-click="@.editExpr(~/temp.bottom.source + '.sort')" tabindex=-1>{{>pencil}}</button></span><div style="height: 5em; border: 1px solid {{@style.border}}; overflow: auto; margin: 0;"><Editor src="{{.sort}}" tabout /></div></label>
        {{#if Array.isArray(.group)}}
          <div class-options style="height: 100%; width: 20rem;">
            <h3>
              <button class-ico class-large title="Add group expression" style-float=right on-click="@context.push('.group', '')">+</button>
              <label><input type="checkbox" checked="{{.group}}" twoway=false on-change="@context.set('.group', undefined)" /> Groups</label>
            </h3>
            <div class-scrolled-wrapper><div as-scrolled>
              {{#each .group}}
                <div class-group-edit>
                  <span>{{@index + 1}}</span>
                  <div style="height: 5em; border: 1px solid {{@style.border}}; overflow: auto; margin: 0.5em; flex-grow: 1;"><Editor src="{{.}}" tabout /></div>
                  <button title="Edit group expression" class-ico on-click="@.editExpr('~/' + @keypath)" tabindex=-1>{{>pencil}}</button>
                  <button title="Remove group expression" class-ico on-click="@context.splice('../', @index, 1)" tabindex=-1>{{>times}}</button>
                </div>
              {{/each}}
            </div></div>
          </div>
        {{else}}
          <label><input title="Group the rows in this source by one or more expression? This should be coordinated with the sort expression, as groups are produced by sequentially processing the source data." type=checkbox on-change="@context.set('.group', [''])" /> Group?</label>
        {{/if}}
      {{/with}}
    </div>
  </div>
</div>

<datalist id="operators">
  {{#each ~/operators}}<option value="{{this.0}}" />{{/each}}
</datalist>

<template id="ast-node">
  <div on-click="~/temp.expr.partpath !== @keypath && [@.link(@keypath, 'temp.expr.part'), @.set('temp.expr.partpath', @keypath)], false" class="ast-node ast-{{(. && ('op' in . ? 'op' : 'v' in . ? 'value' : 'r' in . ? 'ref' : 'wat')) || 'wat'}}" class-ast-active-node="~/temp.expr.partpath === @keypath">
    {{#if ~/temp.expr.partpath === @keypath}}
      <div class-ast-content>
        {{#if . && 'op' in .}}
          <div class-ast-op-name><div>{{prefix}}(<input value={{.op}} list=operators /></div>{{>ast-actions}}</div>
          {{#each .args}}{{>ast-node}}{{/each}}
          <div>) <button class-ico on-click="@context.push('.args', { v: '' })">+</button></div>
          {{elseif . && 'v' in .}}{{!TODO: array, object, date?}}
            <div class-ast-content-value>
              <div>
                {{prefix}}
                {{#if typeof .v === 'string'}}<textarea rows=1 cols=30>{{.v}}</textarea>
                {{elseif typeof .v === 'number'}}<input value={{.v}} type=number />
                {{/if}}
              </div>
              {{>ast-actions}}
            </div>
        {{elseif . && 'r' in .}}
          <div class-ast-content-ref>
            <div>{{prefix}}<input value={{.r}} /></div>
            {{>ast-actions}}
          </div>
        {{/if}}
      </div>
    {{else}}
      <div class-ast-content>
        {{#if . && 'op' in .}}
          <div class-ast-op-name><div>{{prefix}}({{.op}}</div>{{>ast-dim-actions}}</div>
          {{#if ~/operators[.op] && ~/operators[.op].type === 'aggregate'}}
            {{#if .source}}{{>ast-node .source, '+ ' as prefix}}{{/if}}
            {{#if .apply}}{{>ast-node .apply, '=> ' as prefix}}{{/if}}
          {{/if}}
          {{#each .args}}{{>ast-node}}{{/each}}
          )
        {{elseif . && 'v' in .}}{{!TODO: array, object, date?}}
          <div class-ast-content-value><div class-ast-string="typeof .v === 'string'" class-ast-number="typeof .v === 'number'">{{prefix}}{{.v}}</div>{{>ast-dim-actions}}</div>
        {{elseif . && 'r' in .}}
          <div class-ast-content-ref><div>{{prefix}}{{.r}} (ref)</div>{{>ast-dim-actions}}</div>
        {{/if}}
      </div>
    {{/if}}
  </div>
</template>

<template id="ast-actions">
  <div class-ast-actions>
    {{#if ~/operators[.op] && ~/operators[.op].type === 'aggregate'}}
      {{#unless .source}}<button class="ico text" on-click="@context.set('.source', { r: '' })">+ Source</button>{{/unless}}
      {{#unless .apply}}<button class="ico text" on-click="@context.set('.apply', { r: '' })">+ Application</button>{{/unless}}
    {{/if}}
    <select twoway=false on-change="@.retypeASTNode(@keypath, @node.value)" value="{{. && 'op' in . ? 'operator' : . && 'v' in . ? (typeof .v === 'string' ? 'string' : typeof .v === 'number' ? 'number' : 'object') : . && 'r' in . ? 'reference' : 'undefined'}}">
      <option>operator</option>
      <option>string</option>
      <option>number</option>
      <option>reference</option>
      <option>undefined</option>
    </select>
    <button class-ico on-click="Array.isArray(../) ? @context.splice('../', @index, 1) : @context.set('.', undefined)">{{>times}}</button>
  </div>
</template>

<template id="ast-dim-actions">
  <div class-ast-actions>
    <button class-ico on-click="Array.isArray(../) ? @context.splice('../', @index, 1) : @context.set('.', undefined)">{{>times}}</button>
  </div>
</template>

<template id="expr-context">
  {{#each .fields}}{{#if !~/ctxsearch || .fields || ~.name.indexOf(~/ctxsearch)}}
    <div class-context-entry class-entry-local=".meta.local" class-expanded="~/exprExpand[@keypath]">
      <div class-entry-details>
        <div>
          {{#if .fields}}<button class-expand on-click="@.exprToggle(@keypath)">{{~/exprExpand[@keypath] ? '-' : '+'}}</button>{{/if}}
          <button class-entry-name on-click="@.insertRef(@keypath)">{{.name}}</button>
        </div>
        <div class-entry-type>{{.type}}</div>
      </div>
      {{#if .fields}}{{>expr-context}}{{/if}}
    </div>
  {{/if}}{{/each}}
</template>

<template id="bottom-parameters" src="./params.ractive.html" />

<style rel=ractive>
  .bottom-pane pre {
    margin: 0;
  }

  .bottom-pane .top {
    display: flex;
    flex-shrink: 0;
    flex-grow: 0;
    box-sizing: border-box;
    height: 2.5em;
    font-size: 0.75rem;
    align-items: end;
  }

  .bottom-pane .bottom {
    display: flex;
    flex-grow: 1;
    flex-shrink: 1;
    overflow: hidden;
    height: 100%;
  }

  .bottom-pane .bottom > .tab {
    display: flex;
    flex-grow: 0;
    border: none;
    display: none;
    overflow: auto;
  }
  .bottom-pane .bottom > .active-tab {
    flex-grow: 1;
    display: flex;
  }

  .bottom-pane .context, .bottom-pane .ops {
    margin: 0.2em;
    width: 25%;
    max-width: 20em;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .bottom-pane .context .panel, .bottom-pane .ops .panel {
    border: 1px solid {{@style.border}};
    flex-grow: 1;
  }

  .bottom-pane .context .header, .bottom-pane .ops .header {
    flex-wrap: wrap;
    font-weight: bold;
    display: flex;
    justify-content: space-evenly;
    line-height: 2.2em;
    font-size: 0.85rem;
  }

  .bottom-pane .editor {
    flex-grow: 2;
    display: flex;
    flex-direction: column;
    padding: 0.25rem;
    box-sizing: border-box;
  }
  
  .bottom-pane textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 0.5em;
    min-height: 99%;
    border: none;
    outline: none;
    font-size: 1em;
  }

  .bottom-pane .properties textarea, .bottom-pane .properties select, .bottom-pane input {
    color: {{@style.fg}};
    background-color: {{@style.bg}};
    border: 1px solid {{@style.border}};
  }
  .bottom-pane .properties textarea {
    min-height: 7em;
  }

  .bottom-pane .active-tab {
    border: 1px solid {{@style.border}};
  }

  .bottom-pane .editor .tab {
    display: flex;
    flex-direction: column;
  }

  .bottom-pane .ast.tab {
    word-wrap: anywhere;
    word-break: break-all;
  }
  .bottom-pane .ast.tab.error {
    border-color: {{@style.error}};
  }

  .bottom-pane .tab.html .scrolled {
    display: flex;
    flex-direction: column;
  }

  .bottom-pane .tab.result .scrolled {
    padding: 0.5rem;
  }

  .bottom-pane .tab.html, .bottom-pane .tab.result {
    display: flex;
    flex-direction: column;
  }

  .bottom-pane .tab .editor-buttons {
    display: flex;
    flex-shrink: 0;
    padding: 0.2rem;
    border-bottom: 1px solid {{@style.border}};
  }

  .bottom-pane .tab.html button {
    border: none;
    background-color: transparent;
    padding: 0.25rem;
    cursor: pointer;
    outline: none;
  }
  .bottom-pane .tab.html button:hover {
    color: {{@style.active}};
  }
  .bottom-pane .tab.html button.skip {
    margin-left: 1rem;
  }

  .bottom-pane .html-editor {
    padding: 0.5rem;
    flex-grow: 1;
    flex-shrink: 1;
    white-space: pre-wrap;
    word-wrap: anywhere;
    word-break: break-all;
  }

  .bottom-pane pre {
    white-space: pre-wrap;
    word-break: break-all;
  }

  .bottom-pane .properties {
    flex-direction: column;
    flex-wrap: wrap;
    align-content: flex-start;
  }
  .bottom-pane .properties > label {
    width: 20em;
    margin: 0 0.5rem;
    padding: 0.5rem 0;
  }
  .bottom-pane .options label {
    display: inline-block;
  }
  .bottom-pane .options label > span:first-of-type {
    font-size: 0.8rem;
  }
  .bottom-pane .properties > label > span:first-of-type {
    font-size: 0.8rem;
    display: flex;
    align-items: center;
  }
  .bottom-pane .options {
    box-sizing: border-box;
    padding: 0.5rem;
    border: 1px solid {{@style.border}};
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .bottom-pane .group-edit {
    display: flex;
    align-items: center;
  }

  .ast-node {
    margin-left: 0.5em;
    display: flex;
    cursor: pointer;
    min-height: 2em;
    border: 1px solid transparent;
  }

  .ast-node input, .ast-node select {
    border: 1px solid rgba(0, 0, 0, 0.15);
    background-color: {{@style.bg}};
    padding: 0.2em;
  }

  .ast-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .ast-active-node {
    background-color: {{@style.active}}20;
    border: 1px solid {{@style.active}};
    cursor: default;
  }

  .ast-string:before, .ast-string:after {
    content: '"';
  }

  .ast-number {
    font-family: mono;
  }

  .ast-op-name, .ast-content-value, .ast-content-ref {
    display: flex;
    justify-content: space-between;
  }

  .entry-local .entry-name {
    font-style: italic;
  }

  .entry-details {
    display: flex;
    justify-content: space-between;
  }

  .entry-type {
    opacity: 0.6;
    padding: 0 0.5em;
  }

  .entry-details button {
    text-align: left;
    padding: 0;
    background: none;
    border: none;
    margin: 0;
    font-size: 1rem;
    color: {{@style.fg}};
    background-color: {{@style.bg}};
  }

  .entry-details button.expand {
    margin-left: -1em;
    color: {{@style.fg}};
    background-color: {{@style.bg}};
    border: 1px solid {{@style.border}};
    width: 1em;
    height: 1em;
    text-align: center;
    line-height: 0.6em;
  }

  .context-entry {
    padding-left: 0.5em;
    border-left: 1px dotted {{@style.border}};
    margin-left: 1em;
  }
  .context-entry .context-entry {
    margin-left: 0.5em;
  }
  .context-entry > .context-entry {
    display: none;
  }
  .context-entry.expanded > .context-entry {
    display: block;
  }

  .expr-operator, .context-entry {
    cursor: pointer;
  }

  .entry-details .expr-operator {
    padding: 0 0.5em;
  }

  .label-part {
    padding: 0.25em;
    margin: 0.25em;
    border: 1px solid;
    border-radius: 0.2em;
  }

  .label-part code {
    background-color: {{@style.bg}};
    color: {{@style.fg}};
  }

  .label-part input, .label-part label, .label-part select {
    font-size: 0.8rem;
    padding: 0.25em;
    border-radius: 0.2rem;
    margin: 0.25em;
    vertical-align: middle;
    border: 1px solid {{@style.border}};
    color: {{@style.fg}};
    background-color: {{@style.bg}};
  }
  .label-part input[type=number] {
    width: 8rem;
  }
  .label-part label {
    white-space: nowrap;
  }

  .option-entry {
    box-sizing: border-box;
    display: flex;
    margin-bottom: 0.5em;
    align-items: end;
    justify-content: space-between;
  }
  .option-entry > * {
    flex-shrink: 1;
    flex-grow: 1;
    margin: 0.2em;
  }

  .bottom-pane dt {
    margin-top: 1rem;
    font-family: monospace;
  }
  .bottom-pane dd {
    margin: 0.5em 0 1em 2em;
  }

  .bottom-pane .ops-search {
    width: 10em;
    position: absolute;
    right: 0;
    top: 0;
    background-color: {{@style.bg}};
    padding: 0.5rem;
    border: 1px solid;
    border-radius: 0 0 0 0.5em;
    border-width: 0 0 1px 1px;
    opacity: 0.4;
    transition: opacity 0.2s ease-in-out;
  }
  .bottom-pane .ops-search:hover {
    opacity: 1;
  }
</style>
